# Database Migrations

ì´ í´ë”ì—ëŠ” Supabase PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ ë³´ì•ˆ ì •ì±…ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë°©ë²•

### 1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤í–‰

1. [Supabase Dashboard](https://app.supabase.com) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ (bnlxygirvfueroigbzkl)
3. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­
4. **New query** ë²„íŠ¼ í´ë¦­
5. ê° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°
6. **Run** ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì‹¤í–‰

### 2. ì‹¤í–‰ ìˆœì„œ

ë°˜ë“œì‹œ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

```bash
# 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„±
001_initial_schema.sql

# 2ë‹¨ê³„: Row Level Security ì •ì±… ì„¤ì •
002_rls_policies.sql

# 3ë‹¨ê³„: Auth Users ë™ê¸°í™” (âš ï¸ í•„ìˆ˜ - ì¦‰ì‹œ ì‹¤í–‰ í•„ìš”)
003_auth_users_sync.sql
```

## ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì„¤ëª…

### 001_initial_schema.sql
- **ëª©ì **: ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„±
- **í¬í•¨ ë‚´ìš©**:
  - UUID í™•ì¥ ê¸°ëŠ¥ í™œì„±í™”
  - 6ê°œ í…Œì´ë¸” ìƒì„± (users, trends, creators, content_ideas, reports, api_usage)
  - ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
  - ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  - ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ„í•œ ì œì•½ ì¡°ê±´

### 002_rls_policies.sql
- **ëª©ì **: í…Œì´ë¸”ë³„ ë³´ì•ˆ ì •ì±… ì„¤ì •
- **í¬í•¨ ë‚´ìš©**:
  - ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
  - ì‚¬ìš©ì ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ ì •ì±…
  - Admin ê¶Œí•œ ì‚¬ìš©ì íŠ¹ë³„ ì •ì±…
  - ë°ì´í„° ì†Œìœ ì ê¸°ë°˜ ì ‘ê·¼ ì œì–´

### 003_auth_users_sync.sql (âš ï¸ í•„ìˆ˜ - ì¦‰ì‹œ ì‹¤í–‰ í•„ìš”)
- **ëª©ì **: Supabase Authì™€ public.users í…Œì´ë¸” ë™ê¸°í™”
- **í¬í•¨ ë‚´ìš©**:
  - users í…Œì´ë¸” ì¬ìƒì„± (auth.users.id ì°¸ì¡°)
  - ì‹ ê·œ ì‚¬ìš©ì ê°€ì… ì‹œ ìë™ í”„ë¡œí•„ ìƒì„± íŠ¸ë¦¬ê±°
  - ê¸°ì¡´ auth.users ë°ì´í„° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
  - reports í…Œì´ë¸” ì™¸ë˜í‚¤ ì¬ì„¤ì •
- **ì£¼ì˜ì‚¬í•­**:
  - âš ï¸ users í…Œì´ë¸”ì„ DROPí•˜ê³  ì¬ìƒì„±í•©ë‹ˆë‹¤
  - âš ï¸ ê¸°ì¡´ ë°ì´í„°ëŠ” auth.usersì—ì„œ ìë™ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤
  - âœ… ë¡œê·¸ì¸ ì˜¤ë¥˜ ë° ë¦¬í¬íŠ¸ ìƒì„± ì˜¤ë¥˜ í•´ê²°

## ë³´ì•ˆ ì •ì±… ê°œìš”

### users í…Œì´ë¸”
- ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¡œí•„ë§Œ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥
- Adminì€ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥

### trends í…Œì´ë¸”
- ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
- ì¸ì¦ëœ ì‚¬ìš©ì ìƒì„± ê°€ëŠ¥ (AI Agent)
- Adminë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥

### creators í…Œì´ë¸”
- ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
- ì¸ì¦ëœ ì‚¬ìš©ì ìƒì„±/ìˆ˜ì • ê°€ëŠ¥
- Adminë§Œ ì‚­ì œ ê°€ëŠ¥

### content_ideas í…Œì´ë¸”
- ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
- ì¸ì¦ëœ ì‚¬ìš©ì ìƒì„± ê°€ëŠ¥
- ìƒì„±ì ë³¸ì¸ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- Adminì€ ëª¨ë“  ì•„ì´ë””ì–´ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥

### reports í…Œì´ë¸”
- ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
- ì¸ì¦ëœ ì‚¬ìš©ì ìƒì„± ê°€ëŠ¥
- ìƒì„±ì ë³¸ì¸ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- Adminì€ ëª¨ë“  ë¦¬í¬íŠ¸ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥

### api_usage í…Œì´ë¸”
- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì‚¬ìš© ë‚´ì—­ë§Œ ì¡°íšŒ ê°€ëŠ¥
- Adminì€ ëª¨ë“  ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ ê°€ëŠ¥
- Service Role Keyë¡œë§Œ ìƒì„± ê°€ëŠ¥
- Adminë§Œ ì‚­ì œ ê°€ëŠ¥

## ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸

SQL ì‹¤í–‰ í›„ ë‹¤ìŒ ì¿¼ë¦¬ë¡œ í…Œì´ë¸” ìƒì„±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```sql
-- ëª¨ë“  í…Œì´ë¸” í™•ì¸
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public';

-- RLS í™œì„±í™” í™•ì¸
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';

-- ì •ì±… í™•ì¸
SELECT schemaname, tablename, policyname
FROM pg_policies
WHERE schemaname = 'public';
```

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì˜¤ë¥˜: "extension uuid-ossp does not exist"
- SupabaseëŠ” ê¸°ë³¸ì ìœ¼ë¡œ uuid-osspë¥¼ ì§€ì›í•©ë‹ˆë‹¤
- ë‹¤ì‹œ ì‹¤í–‰í•˜ê±°ë‚˜ Supabase ì§€ì›íŒ€ì— ë¬¸ì˜

### ì˜¤ë¥˜: "relation already exists"
- í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°
- SQL Editorì—ì„œ ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ í›„ ì¬ì‹¤í–‰
- ë˜ëŠ” `DROP TABLE IF EXISTS table_name CASCADE;` ë¨¼ì € ì‹¤í–‰

### ì˜¤ë¥˜: "function auth.uid() does not exist"
- Supabase Authê°€ í™œì„±í™”ë˜ì§€ ì•Šì€ ê²½ìš°
- Supabase Dashboard > Authenticationì—ì„œ í™œì„±í™”

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… 001_initial_schema.sql ì‹¤í–‰
2. âœ… 002_rls_policies.sql ì‹¤í–‰
3. ğŸ”„ TypeScript íƒ€ì… ìƒì„± (`npx supabase gen types typescript`)
4. ğŸ”„ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ (Epic 2.2)
5. ğŸ”„ API ì—”ë“œí¬ì¸íŠ¸ ê°œë°œ (Phase 3)
